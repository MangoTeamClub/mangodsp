<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mango短视频</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            background-color: #111;
            color: #fff;
            display: flex;
            flex-direction: column;
        }
        
        /* 顶部导航栏 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: rgba(0, 0, 0, 0.95);
            border-bottom: 2px solid #ff6600;
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            min-height: 60px;
            flex-shrink: 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            color: #ff6600;
            white-space: nowrap;
        }
        
        .logo i {
            margin-right: 8px;
            font-size: 22px;
        }
        
        .search-container {
            flex: 1;
            max-width: 600px;
            margin: 0 12px;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 16px;
            padding-left: 40px;
            border-radius: 25px;
            border: 2px solid #ff6600;
            background-color: #222;
            color: white;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            box-shadow: 0 0 10px rgba(255, 102, 0, 0.7);
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #ff6600;
            font-size: 16px;
        }
        
        .header-buttons {
            display: flex;
            gap: 12px;
            flex-shrink: 0;
        }
        
        .header-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: color 0.3s;
            padding: 6px;
            position: relative;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .header-btn:hover {
            color: #ff6600;
        }
        
        /* 主要内容区域 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding: 0 10px 20px;
            position: relative;
        }
        
        /* 视频容器 */
        .video-container {
            width: 100%;
            max-width: 800px;
            position: relative;
            margin: 10px 0;
            flex-shrink: 0;
        }
        
        .video-player {
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            background-color: #000;
            position: relative;
            aspect-ratio: 16/9;
        }
        
        video {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: contain;
        }
        
        .video-info {
            padding: 16px;
            background-color: rgba(0, 0, 0, 0.85);
            border-radius: 0 0 10px 10px;
            margin-top: -5px;
        }
        
        .video-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .video-meta {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 12px;
            color: #aaa;
            font-size: 13px;
            gap: 8px;
        }
        
        .video-author {
            color: #ff6600;
            font-weight: 500;
        }
        
        .video-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #ff6600;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.3s;
            flex: 1;
            min-height: 44px;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #ff8533;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 102, 0, 0.4);
        }
        
        .action-btn i {
            font-size: 16px;
        }
        
        .video-nav {
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-between;
            padding: 0 12px;
            pointer-events: none;
            z-index: 100;
        }
        
        .nav-btn {
            background-color: rgba(255, 102, 0, 0.8);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            pointer-events: all;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }
        
        .nav-btn:hover, .nav-btn:active {
            background-color: rgba(255, 102, 0, 1);
            transform: scale(1.1);
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        
        .modal-content {
            background-color: #222;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            border: 2px solid #ff6600;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 18px;
            background-color: #ff6600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
            padding: 5px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            padding: 12px 20px;
            background-color: rgba(0, 0, 0, 0.3);
            text-align: center;
            color: #aaa;
            font-size: 13px;
            flex-shrink: 0;
        }
        
        .favorites-list {
            list-style-type: none;
        }
        
        .favorites-list li {
            padding: 14px;
            border-bottom: 1px solid #444;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .favorites-list li:active {
            background-color: #333;
        }
        
        .favorites-list li:last-child {
            border-bottom: none;
        }
        
        .favorite-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .favorite-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 10px;
            font-size: 15px;
        }
        
        .remove-favorite {
            background: none;
            border: none;
            color: #ff6666;
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
            flex-shrink: 0;
        }
        
        /* 加载指示器 */
        .loader {
            display: none;
            text-align: center;
            padding: 30px;
            color: #ff6600;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        
        .loader i {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        /* 视频占位符 */
        .video-placeholder {
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #ff6600;
            text-align: center;
            padding: 20px;
        }
        
        .video-placeholder i {
            font-size: 50px;
            margin-bottom: 15px;
        }
        
        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #aaa;
        }
        
        .empty-state i {
            font-size: 50px;
            margin-bottom: 15px;
            color: #ff6600;
        }
        
        /* 键盘提示 */
        .keyboard-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            color: #aaa;
            border-left: 3px solid #ff6600;
            z-index: 100;
        }
        
        .key {
            display: inline-block;
            background-color: #333;
            padding: 2px 8px;
            border-radius: 4px;
            margin: 0 3px;
            font-family: monospace;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            .header {
                padding: 10px 12px;
                min-height: 56px;
            }
            
            .logo {
                font-size: 18px;
            }
            
            .logo i {
                font-size: 20px;
                margin-right: 6px;
            }
            
            .search-container {
                margin: 0 8px;
            }
            
            .search-input {
                padding: 8px 14px;
                padding-left: 36px;
                font-size: 13px;
            }
            
            .search-icon {
                left: 10px;
                font-size: 14px;
            }
            
            .header-btn {
                font-size: 18px;
                width: 36px;
                height: 36px;
                padding: 4px;
            }
            
            .header-buttons {
                gap: 8px;
            }
            
            .video-container {
                margin: 5px 0;
            }
            
            .video-info {
                padding: 14px;
            }
            
            .video-title {
                font-size: 16px;
                -webkit-line-clamp: 3;
            }
            
            .video-meta {
                font-size: 12px;
            }
            
            .action-btn {
                padding: 8px 14px;
                font-size: 14px;
                min-height: 40px;
            }
            
            .nav-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .modal-body {
                padding: 16px;
            }
            
            .modal-header {
                padding: 16px;
            }
            
            .modal-title {
                font-size: 18px;
            }
            
            .favorite-title {
                font-size: 14px;
            }
            
            .keyboard-hint {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 8px 10px;
            }
            
            .logo {
                font-size: 16px;
            }
            
            .logo i {
                font-size: 18px;
            }
            
            .search-input {
                padding: 8px 12px;
                padding-left: 34px;
                font-size: 12px;
            }
            
            .video-player {
                border-radius: 8px;
            }
            
            .video-title {
                font-size: 15px;
            }
            
            .video-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            
            .action-btn {
                padding: 8px 12px;
                font-size: 13px;
                min-height: 38px;
            }
            
            .action-btn i {
                font-size: 14px;
            }
            
            .nav-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
            
            .modal {
                padding: 10px;
            }
            
            .modal-content {
                max-height: 85vh;
            }
            
            .favorites-list li {
                padding: 12px;
            }
        }
        
        /* 超小屏幕手机优化 */
        @media (max-width: 360px) {
            .logo span {
                display: none;
            }
            
            .logo i {
                margin-right: 0;
                font-size: 22px;
            }
            
            .search-input {
                padding-left: 32px;
            }
            
            .video-title {
                font-size: 14px;
            }
            
            .action-btn {
                padding: 6px 10px;
                font-size: 12px;
                min-height: 36px;
            }
        }
        
        /* 横屏优化 */
        @media (orientation: landscape) and (max-height: 500px) {
            .header {
                min-height: 50px;
                padding: 8px 12px;
            }
            
            .logo {
                font-size: 16px;
            }
            
            .search-input {
                padding: 6px 12px;
                padding-left: 32px;
                font-size: 12px;
            }
            
            .video-player {
                aspect-ratio: 16/9;
            }
            
            .video-info {
                padding: 12px;
            }
            
            .video-title {
                font-size: 14px;
                margin-bottom: 4px;
                -webkit-line-clamp: 2;
            }
            
            .video-meta {
                margin-bottom: 8px;
                font-size: 11px;
            }
            
            .action-btn {
                padding: 6px 10px;
                font-size: 12px;
                min-height: 32px;
            }
            
            .nav-btn {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
        }
        
        /* 平板设备优化 */
        @media (min-width: 769px) and (max-width: 1024px) {
            .video-container {
                max-width: 90%;
            }
            
            .video-player {
                max-height: 70vh;
            }
        }
        
        /* 防止iOS Safari工具栏影响布局 */
        @supports (-webkit-touch-callout: none) {
            body {
                height: -webkit-fill-available;
            }
            
            .main-content {
                height: -webkit-fill-available;
            }
        }
        
        /* 滚动条样式 */
        .modal-body::-webkit-scrollbar {
            width: 6px;
        }
        
        .modal-body::-webkit-scrollbar-track {
            background: #333;
            border-radius: 3px;
        }
        
        .modal-body::-webkit-scrollbar-thumb {
            background: #ff6600;
            border-radius: 3px;
        }
        
        .main-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #222;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #ff6600;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <header class="header">
        <div class="logo">
            <i class="fas fa-play-circle"></i>
            <span>Mango短视频</span>
        </div>
        
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" id="searchInput" placeholder="搜索视频..." autocomplete="off">
        </div>
        
        <div class="header-buttons">
            <button class="header-btn" id="aboutBtn" title="关于">
                <i class="fas fa-info-circle"></i>
            </button>
            <button class="header-btn" id="favoritesBtn" title="收藏夹">
                <i class="fas fa-heart"></i>
            </button>
        </div>
    </header>

    <!-- 主要内容区域 -->
    <main class="main-content" id="mainContent">
        <div class="video-container">
            <!-- 视频播放区域 -->
            <div class="video-player" id="videoPlayer">
                <div class="video-placeholder" id="videoPlaceholder">
                    <i class="fas fa-play-circle"></i>
                    <p>输入关键词搜索视频</p>
                    <p style="font-size:14px;margin-top:10px;color:#aaa;">加载中</p>
                </div>
                <video id="videoElement" controls style="display:none;">
                    <source id="videoSource" src="" type="video/mp4">
                    您的浏览器不支持视频播放
                </video>
                
                <!-- 视频导航按钮 -->
                <div class="video-nav">
                    <button class="nav-btn" id="prevBtn" title="上一个视频">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                    <button class="nav-btn" id="nextBtn" title="下一个视频">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
            </div>
            
            <!-- 视频信息区域 -->
            <div class="video-info" id="videoInfo" style="display:none;">
                <div class="video-title" id="videoTitle">视频标题</div>
                <div class="video-meta">
                    <div>
                        作者: <span class="video-author" id="videoAuthor">作者名称</span>
                    </div>
                    <div>
                        播放量: <span id="videoPlayCount">0</span>
                    </div>
                    <div>
                        发布时间: <span id="videoPublishTime">刚刚</span>
                    </div>
                </div>
                <div class="video-actions">
                    <button class="action-btn" id="favoriteBtn">
                        <i class="fas fa-heart"></i> 收藏
                    </button>
                    <button class="action-btn" id="shareBtn">
                        <i class="fas fa-share"></i> 分享
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 加载指示器 -->
        <div class="loader" id="loader">
            <i class="fas fa-spinner fa-spin"></i>
            <p>加载中...</p>
        </div>
        
        <!-- 键盘提示 (桌面端显示) -->
        <div class="keyboard-hint" id="keyboardHint">
            使用 <span class="key">↑</span> <span class="key">↓</span> 键或滚轮切换视频
        </div>
    </main>

    <!-- 关于模态框 -->
    <div class="modal" id="aboutModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">关于 Mango短视频</div>
                <button class="close-btn" id="closeAboutBtn">&times;</button>
            </div>
            <div class="modal-body">
                <p>Mango短视频是一个基于B站视频资源的短视频播放应用。</p>
                <p><strong>声明：</strong>本应用提供的所有视频内容均来源于网络，仅用于学习和娱乐目的。</p>
                <p>请尊重视频原作者的知识产权，如需商业使用请联系版权所有者。</p>
                <p>本应用不存储任何视频内容，所有视频均通过API接口实时获取。</p>
                <p>如果您是视频内容的版权所有者，认为本应用侵犯了您的权益，请联系我们。</p>
            </div>
            <div class="modal-footer">
                ©2022-2026 Mango短视频 版权所有
            </div>
        </div>
    </div>

    <!-- 收藏夹模态框 -->
    <div class="modal" id="favoritesModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">我的收藏夹</div>
                <button class="close-btn" id="closeFavoritesBtn">&times;</button>
            </div>
            <div class="modal-body">
                <ul class="favorites-list" id="favoritesList">
                    <!-- 收藏项将通过JS动态添加 -->
                </ul>
                <div class="empty-state" id="emptyFavorites" style="display:none;">
                    <i class="fas fa-heart-broken"></i>
                    <p>收藏夹为空</p>
                    <p>收藏的视频将显示在这里</p>
                </div>
            </div>
            <div class="modal-footer">
                点击视频名称即可播放
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentVideoList = [];
        let currentVideoIndex = 0;
        let currentSearchKeyword = '';
        let favorites = JSON.parse(localStorage.getItem('mangoFavorites')) || [];
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // 新增变量：用于推荐视频功能
        let isRecommendationMode = true; // 标记当前是否处于推荐模式
        let recommendationCount = 0; // 当前推荐词下已播放的视频计数
        let currentRecommendationIndex = 0; // 当前推荐词的索引
        const recommendations = ['搞笑', '猫meme', '抽象', '音乐', '游戏','我的世界','Mango团队','Mango画社','电影','编程','疯狂动物城'];
        
        // DOM元素
        const searchInput = document.getElementById('searchInput');
        const videoElement = document.getElementById('videoElement');
        const videoSource = document.getElementById('videoSource');
        const videoPlaceholder = document.getElementById('videoPlaceholder');
        const videoInfo = document.getElementById('videoInfo');
        const videoTitle = document.getElementById('videoTitle');
        const videoAuthor = document.getElementById('videoAuthor');
        const videoPlayCount = document.getElementById('videoPlayCount');
        const videoPublishTime = document.getElementById('videoPublishTime');
        const mainContent = document.getElementById('mainContent');
        const loader = document.getElementById('loader');
        const aboutBtn = document.getElementById('aboutBtn');
        const favoritesBtn = document.getElementById('favoritesBtn');
        const aboutModal = document.getElementById('aboutModal');
        const favoritesModal = document.getElementById('favoritesModal');
        const closeAboutBtn = document.getElementById('closeAboutBtn');
        const closeFavoritesBtn = document.getElementById('closeFavoritesBtn');
        const favoriteBtn = document.getElementById('favoriteBtn');
        const favoritesList = document.getElementById('favoritesList');
        const emptyFavorites = document.getElementById('emptyFavorites');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const keyboardHint = document.getElementById('keyboardHint');
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 如果是移动设备，隐藏键盘提示
            if (isMobile) {
                keyboardHint.style.display = 'none';
            }
            
            // 绑定事件监听器
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    // 用户主动搜索时，退出推荐模式
                    isRecommendationMode = false;
                    recommendationCount = 0;
                    searchVideos();
                }
            });
            
            aboutBtn.addEventListener('click', () => showModal(aboutModal));
            favoritesBtn.addEventListener('click', () => {
                renderFavorites();
                showModal(favoritesModal);
            });
            
            closeAboutBtn.addEventListener('click', () => hideModal(aboutModal));
            closeFavoritesBtn.addEventListener('click', () => hideModal(favoritesModal));
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(e) {
                if (e.target === aboutModal) hideModal(aboutModal);
                if (e.target === favoritesModal) hideModal(favoritesModal);
            });
            
            favoriteBtn.addEventListener('click', toggleFavorite);
            
            prevBtn.addEventListener('click', prevVideo);
            nextBtn.addEventListener('click', nextVideo);
            
            // 键盘快捷键 (桌面端)
            if (!isMobile) {
                document.addEventListener('keydown', function(e) {
                    // 上下箭头切换视频
                    if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                        e.preventDefault();
                        if (e.key === 'ArrowUp') prevVideo();
                        if (e.key === 'ArrowDown') nextVideo();
                    }
                    
                    // ESC键关闭模态框
                    if (e.key === 'Escape') {
                        hideModal(aboutModal);
                        hideModal(favoritesModal);
                    }
                });
            }
            
            // 鼠标滚轮切换视频 (桌面端)
            if (!isMobile) {
                mainContent.addEventListener('wheel', function(e) {
                    // 如果正在滚动视频区域，切换视频
                    if (e.deltaY !== 0 && currentVideoList.length > 0) {
                        e.preventDefault();
                        if (e.deltaY > 0) nextVideo();
                        else prevVideo();
                    }
                }, { passive: false });
            }
            
            // 移动端触摸滑动切换视频
            if (isMobile) {
                let touchStartY = 0;
                let touchEndY = 0;
                
                mainContent.addEventListener('touchstart', function(e) {
                    touchStartY = e.changedTouches[0].screenY;
                }, { passive: true });
                
                mainContent.addEventListener('touchend', function(e) {
                    touchEndY = e.changedTouches[0].screenY;
                    handleSwipe();
                }, { passive: true });
                
                function handleSwipe() {
                    const swipeThreshold = 50;
                    const swipeDistance = touchStartY - touchEndY;
                    
                    // 垂直滑动超过阈值
                    if (Math.abs(swipeDistance) > swipeThreshold) {
                        if (swipeDistance > 0) {
                            // 向上滑动 - 下一个视频
                            nextVideo();
                        } else {
                            // 向下滑动 - 上一个视频
                            prevVideo();
                        }
                    }
                }
            }
            
            // 初始加载推荐视频
            loadNextRecommendation();
            
            // 调整视频容器高度，防止键盘弹出时遮挡
            window.addEventListener('resize', adjustLayout);
            adjustLayout();
        });
        
        // 调整布局
        function adjustLayout() {
            // 设置主要内容区域高度
            const headerHeight = document.querySelector('.header').offsetHeight;
            const windowHeight = window.innerHeight;
            mainContent.style.height = (windowHeight - headerHeight) + 'px';
        }
        
        // 显示模态框
        function showModal(modal) {
            modal.style.display = 'flex';
            // 防止背景滚动
            document.body.style.overflow = 'hidden';
        }
        
        // 隐藏模态框
        function hideModal(modal) {
            modal.style.display = 'none';
            // 恢复背景滚动
            document.body.style.overflow = '';
        }
        
        // 搜索视频
        async function searchVideos() {
            const keyword = searchInput.value.trim();
            if (!keyword) return;
            
            currentSearchKeyword = keyword;
            showLoader();
            
            // 移动端收起键盘
            if (isMobile) {
                searchInput.blur();
            }
            
            try {
                // 调用第一个API获取视频列表
                const response = await fetch(`https://api.jkyai.top/API/bilibilijx.php?msg=${encodeURIComponent(keyword)}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    currentVideoList = data.data;
                    currentVideoIndex = 0;
                    
                    // 获取并播放第一个视频
                    await loadVideoByIndex(0);
                } else {
                    hideLoader();
                    alert('未找到相关视频，请尝试其他关键词');
                }
            } catch (error) {
                hideLoader();
                console.error('搜索视频出错:', error);
                alert('搜索失败，请检查网络连接');
            }
        }
        
        // 加载下一个推荐词
        async function loadNextRecommendation() {
            // 如果不在推荐模式，则不加载推荐
            if (!isRecommendationMode) return;
            
            // 获取下一个推荐词
            const keyword = recommendations[currentRecommendationIndex];
            currentRecommendationIndex = (currentRecommendationIndex + 1) % recommendations.length;
            
            // 更新搜索框
            searchInput.value = keyword;
            currentSearchKeyword = keyword;
            
            // 重置推荐计数
            recommendationCount = 0;
            
            // 搜索推荐视频
            showLoader();
            
            try {
                const response = await fetch(`https://api.jkyai.top/API/bilibilijx.php?msg=${encodeURIComponent(keyword)}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    currentVideoList = data.data;
                    currentVideoIndex = 0;
                    
                    // 获取并播放第一个视频
                    await loadVideoByIndex(0);
                } else {
                    hideLoader();
                    // 如果当前推荐词没有结果，尝试下一个推荐词
                    setTimeout(loadNextRecommendation, 1000);
                }
            } catch (error) {
                hideLoader();
                console.error('加载推荐视频出错:', error);
                // 出错时也尝试下一个推荐词
                setTimeout(loadNextRecommendation, 1000);
            }
        }
        
        // 根据索引加载视频
        async function loadVideoByIndex(index) {
            if (index < 0 || index >= currentVideoList.length) return;
            
            currentVideoIndex = index;
            const video = currentVideoList[index];
            
            // 显示视频信息
            updateVideoInfo(video);
            
            // 检查是否已收藏
            updateFavoriteButton(video);
            
            // 加载视频详情（第二个API）
            showLoader();
            
            try {
                const response = await fetch(`https://api.jkyai.top/API/bilibilijx.php?msg=${encodeURIComponent(currentSearchKeyword)}&n=${index + 1}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.video_url) {
                    // 设置视频源并播放
                    videoSource.src = data.data.video_url;
                    videoElement.load();
                    
                    // 隐藏占位符，显示视频
                    videoPlaceholder.style.display = 'none';
                    videoElement.style.display = 'block';
                    videoInfo.style.display = 'block';
                    
                    // 自动播放视频
                    videoElement.play().catch(e => {
                        console.log('自动播放被阻止，需要用户交互');
                    });
                    
                    // 滚动到视频区域
                    mainContent.scrollTo(0, 0);
                } else {
                    throw new Error('无法获取视频URL');
                }
            } catch (error) {
                console.error('加载视频出错:', error);
                
                // 显示错误信息
                videoPlaceholder.innerHTML = `
                    <div>
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>视频加载失败</p>
                        <p style="font-size:14px;margin-top:10px;color:#aaa;">${error.message || '请检查网络连接'}</p>
                    </div>
                `;
                videoPlaceholder.style.display = 'flex';
                videoElement.style.display = 'none';
                videoInfo.style.display = 'block';
            } finally {
                hideLoader();
            }
        }
        
        // 更新视频信息显示
        function updateVideoInfo(video) {
            videoTitle.textContent = video.title;
            videoAuthor.textContent = video.author;
            videoPlayCount.textContent = video.play_count;
            videoPublishTime.textContent = video.publish_time;
        }
        
        // 更新收藏按钮状态
        function updateFavoriteButton(video) {
            const isFavorited = favorites.some(fav => 
                fav.title === video.title && fav.author === video.author);
            
            if (isFavorited) {
                favoriteBtn.innerHTML = '<i class="fas fa-heart"></i> 已收藏';
                favoriteBtn.style.backgroundColor = '#ff3333';
            } else {
                favoriteBtn.innerHTML = '<i class="fas fa-heart"></i> 收藏';
                favoriteBtn.style.backgroundColor = '#ff6600';
            }
        }
        
        // 切换收藏状态
        function toggleFavorite() {
            const currentVideo = currentVideoList[currentVideoIndex];
            if (!currentVideo) return;
            
            const index = favorites.findIndex(fav => 
                fav.title === currentVideo.title && fav.author === currentVideo.author);
            
            if (index === -1) {
                // 添加到收藏
                favorites.push({
                    ...currentVideo,
                    keyword: currentSearchKeyword,
                    index: currentVideoIndex
                });
                favoriteBtn.innerHTML = '<i class="fas fa-heart"></i> 已收藏';
                favoriteBtn.style.backgroundColor = '#ff3333';
                
                // 添加收藏动画效果
                favoriteBtn.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    favoriteBtn.style.transform = 'scale(1)';
                }, 200);
            } else {
                // 从收藏中移除
                favorites.splice(index, 1);
                favoriteBtn.innerHTML = '<i class="fas fa-heart"></i> 收藏';
                favoriteBtn.style.backgroundColor = '#ff6600';
            }
            
            // 保存到本地存储
            localStorage.setItem('mangoFavorites', JSON.stringify(favorites));
            
            // 更新收藏夹显示（如果打开的话）
            if (favoritesModal.style.display === 'flex') {
                renderFavorites();
            }
        }
        
        // 渲染收藏夹
        function renderFavorites() {
            favoritesList.innerHTML = '';
            
            if (favorites.length === 0) {
                emptyFavorites.style.display = 'block';
                return;
            }
            
            emptyFavorites.style.display = 'none';
            
            favorites.forEach((fav, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="favorite-item">
                        <div class="favorite-title" title="${fav.title}">${fav.title}</div>
                        <button class="remove-favorite" data-index="${index}" title="移除收藏">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div style="font-size:12px;color:#aaa;margin-top:5px;">
                        作者: ${fav.author} | 发布时间: ${fav.publish_time}
                    </div>
                `;
                
                // 点击播放收藏的视频
                li.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('remove-favorite') && 
                        !e.target.parentElement.classList.contains('remove-favorite')) {
                        playFavorite(fav, index);
                        hideModal(favoritesModal);
                    }
                });
                
                // 移除收藏按钮
                const removeBtn = li.querySelector('.remove-favorite');
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeFavorite(index);
                });
                
                favoritesList.appendChild(li);
            });
        }
        
        // 播放收藏的视频
        async function playFavorite(fav, favIndex) {
            // 设置搜索关键词
            searchInput.value = fav.keyword || fav.title.substring(0, 20);
            currentSearchKeyword = fav.keyword || fav.title.substring(0, 20);
            
            // 退出推荐模式
            isRecommendationMode = false;
            
            // 重新搜索
            showLoader();
            
            try {
                const response = await fetch(`https://api.jkyai.top/API/bilibilijx.php?msg=${encodeURIComponent(currentSearchKeyword)}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    currentVideoList = data.data;
                    
                    // 尝试找到相同的视频
                    const videoIndex = currentVideoList.findIndex(v => 
                        v.title === fav.title && v.author === fav.author);
                    
                    if (videoIndex !== -1) {
                        currentVideoIndex = videoIndex;
                        await loadVideoByIndex(videoIndex);
                    } else {
                        // 如果找不到，播放列表中的第一个
                        currentVideoIndex = 0;
                        await loadVideoByIndex(0);
                    }
                }
            } catch (error) {
                console.error('播放收藏视频出错:', error);
                alert('无法加载收藏的视频');
                hideLoader();
            }
        }
        
        // 移除收藏
        function removeFavorite(index) {
            favorites.splice(index, 1);
            localStorage.setItem('mangoFavorites', JSON.stringify(favorites));
            renderFavorites();
            
            // 如果当前视频被移除，更新收藏按钮
            const currentVideo = currentVideoList[currentVideoIndex];
            if (currentVideo) {
                updateFavoriteButton(currentVideo);
            }
        }
        
        // 上一个视频
        function prevVideo() {
            if (currentVideoList.length === 0) return;
            
            let newIndex = currentVideoIndex - 1;
            if (newIndex < 0) newIndex = currentVideoList.length - 1;
            
            loadVideoByIndex(newIndex);
        }
        
        // 下一个视频
        function nextVideo() {
            if (currentVideoList.length === 0) return;
            
            // 如果在推荐模式下，增加计数
            if (isRecommendationMode) {
                recommendationCount++;
                
                // 每播放5个视频，切换到下一个推荐词
                if (recommendationCount >= 5) {
                    loadNextRecommendation();
                    return;
                }
            }
            
            let newIndex = currentVideoIndex + 1;
            if (newIndex >= currentVideoList.length) newIndex = 0;
            
            loadVideoByIndex(newIndex);
        }
        
        // 显示加载指示器
        function showLoader() {
            loader.style.display = 'block';
        }
        
        // 隐藏加载指示器
        function hideLoader() {
            loader.style.display = 'none';
        }
        
        // 分享功能
        document.getElementById('shareBtn').addEventListener('click', function() {
            const currentVideo = currentVideoList[currentVideoIndex];
            if (!currentVideo) return;
            
            const shareText = `我正在Mango短视频观看: ${currentVideo.title} - 作者: ${currentVideo.author}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Mango短视频',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                // 复制到剪贴板作为后备方案
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('分享内容已复制到剪贴板');
                }).catch(() => {
                    // 如果复制失败，显示分享文本
                    alert(shareText + '\n\n(请手动复制分享)');
                });
            }
        });
        
        // 监听屏幕方向变化
        window.addEventListener('orientationchange', function() {
            setTimeout(adjustLayout, 300);
        });
    </script>
</body>
</html>
